---
title: "FinalLeafNumberSet"
format: html
---


```{r setup, echo = FALSE}
setup_qmd()
```

A data structure in APSIM Next Generation that stores final leaf number (FLN) observations or estimates for a genotype under controlled environmental conditions. These observations quantify the effects of vernalisation and photoperiod treatments on leaf development, supporting genotype-specific parameterisation of phenology models.

## Overview

`FinalLeafNumberSet` defines the final leaf number (FLN) under four treatments in controlled environments [@bloomfield_vernalisation_2023]:

* **LV**: fully vernalised, long photoperiod (>16h)
* **SV**: fully vernalised, short photoperiod (<8h)
* **SN**: un-vernalised, short photoperiod (<8h)
* **LN**: un-vernalised, long photoperiod (>16h)

These four treatments represent the combinations of vernalisation (present/absent) and photoperiod (long/short) that define the phenotypic plasticity of leaf number in response to environmental cues. The data structure is used within the [CAMP](/docs/Models/PMF/Phenology/CAMP/CAMP.qmd) framework to parameterise genotype-specific responses and calculate vernalisation rate parameters via [CalcCAMPVrnRates](/docs/Models/PMF/Phenology/CAMP/CalcCAMPVrnRates.qmd).

## Model Structure

{{< include /_includes/Models/model-structure-intro.md >}}

* [Model](/docs/Models/Core/Model.qmd)

## Connections to Other Components

{{< include /_includes/Models/connections-intro.md >}}

This data structure is used by:

| Component | Model | Connection Type | Description                                          |
|-----------|-------|-----------------|------------------------------------------------------|
| CAMP | [CAMP](/docs/Models/PMF/Phenology/CAMP/CAMP.qmd) | Parent | Phenology model that uses FLN data for parameterisation. |
| CalcCAMPVrnRates | [CalcCAMPVrnRates](/docs/Models/PMF/Phenology/CAMP/CalcCAMPVrnRates.qmd) | Used by | Calculates vernalisation rate parameters from FLN data. |

## Model Variables

{{< include /_includes/Models/model-variables-intro.md >}}

**Configurable and Reportable Properties**

This model defines four fixed parameters that are typically derived from controlled environment experiments:

| Property    | Type   | Description                                                                 |
|-------------|--------|-----------------------------------------------------------------------------|
| MinLN       | double | Final Leaf Number under full vernalisation and long photoperiod (>16h)      |
| PpLN        | double | Increase in FLN under short photoperiod (<8h) following full vernalisation  |
| VrnLN       | double | Increase in FLN when un-vernalised and grown under short photoperiod        |
| VxPLN       | double | Change in FLN from photoperiod effect under un-vernalised, long-day growth  |

### Calculated Properties

The model exposes computed FLN values based on defined treatment combinations:

- **LV** (Long photoperiod, fully vernalised):  

$$ \text{LV} = \text{MinLN} $$

- **SV** (Short photoperiod, fully vernalised):  

$$ \text{SV} = \text{MinLN} + \text{PpLN} $$

- **SN** (Short photoperiod, un-vernalised):  

$$ \text{SN} = \text{MinLN} + \text{PpLN} + \text{VrnLN} $$

- **LN** (Long photoperiod, un-vernalised):  
$$ \text{LN} = \text{MinLN} + \text{VrnLN} + \text{VxPLN} $$

These equations represent the phenotypic plasticity of FLN in response to vernalisation and photoperiod interactions.

### Reverse Calculation

Conversely, the model parameters can be derived from the final leaf number (FLN) values observed in controlled environment experiments:

- **MinLN**:  

$$ \text{MinLN} = \text{LV} $$ 

- **PpLN**:  

$$ \text{PpLN} = \text{SV} - \text{LV} $$

- **VrnLN**:  

$$ \text{VrnLN} = \text{SN} - \text{SV} $$

- **VxPLN**:

$$ \text{VxPLN} = \text{LN} - \text{LV} - \left(\text{SN} - \text{SV}\right) $$

These reverse equations allow researchers to translate controlled environment observations into model parameters that can be used for simulation.

**Read-Only Reportable Properties**

The model provides the following calculated (read-only) properties representing FLN under the four treatment combinations:

| Property    | Type   | Description                                                                 |
|-------------|--------|-----------------------------------------------------------------------------|
| LV          | double | FLN under full vernalisation and long photoperiod (>16h)                    |
| SV          | double | FLN under full vernalisation and short photoperiod (<8h)                    |
| SN          | double | FLN when un-vernalised under short photoperiod                              |
| LN          | double | FLN when un-vernalised under long photoperiod                               |

## User Interface

`FinalLeafNumberSet` can be added as a child of a [CAMP](/docs/Models/PMF/Phenology/CAMP/CAMP.qmd) node in the model tree. Right-click the CAMP node, select "Add Model...", and search for `FinalLeafNumberSet` in the Filter Box.

Parameters (MinLN, PpLN, VrnLN, VxPLN) are typically configured based on controlled environment experiments or cultivar characterisation studies.

## Practical Example


```{r define-parameters}
fln_data <- data.frame(
    Parameter_FLN = c("MinLN", "PpLN", "VrnLN", "VxPLN"),
    Emu_Rock = c(6, 1, 1, -1),
    Sunlamb = c(7, 5, 10, -5)
) |> 
    pivot_longer(cols = c("Emu_Rock", "Sunlamb"), names_to = "Cultivar", values_to = "FLN")

fln_long <- calculate_fln(fln_data)
```

Below is a summary table for two cultivars including very quick maturity `Emu_Rock` and very late maturity `Sunlamb` [@celestina_cultivar_2023], showing their parameter values and calculated FLN for each treatment:

```{r tbl-cultivar-parameters, results = "asis"}
fln_long |>
    dplyr::select(Parameter = Parameter_FLN, Cultivar, FLN) |>
    pivot_wider(names_from = Cultivar, values_from = FLN) |>
    knitr::kable(digits = 2, caption = "Final Leaf Number Parameters for Emu_Rock and Sunlamb Cultivars")
```


This figure illustrates the final leaf number (FLN) for the BattenWinter and BattenSpring cultivars under different treatments, including the contributions of each parameter to the final leaf number.

```{r fig-fln, fig.height=8, fig.cap="Final Leaf Number (FLN) for BattenWinter and BattenSpring cultivars"}
library(ggplot2)
library(tidyr)
library(dplyr)        
plot_fln(fln_data)
```



## See Also

* **Source code:** [FinalLeafNumberSet.cs on GitHub](http://github.com/APSIMInitiative/ApsimX/blob/master/Models/PMF/Phenology/CAMP/FinalLeafNumberSet.cs)

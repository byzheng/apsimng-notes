<!--
This file provides the shared Thermal Time documentation used by multiple plant models based on following methodology

* [Three hourly interpolation](/docs/Models/Functions/ThreeHourAirTemperature.qmd) of air temperature from daily max/min
* A response curve defined by three cardinal temperatures: base (0°C), optimum (30°C), maximum (40°C)
* [Sub-daily interpolation](/docs/Models/Functions/SubDailyInterpolation.qmd) to calculate daily thermal time accumulation

Inputs (passed from parent QMD via params):
- plant: The plant model using this thermal time calculation (e.g., Oats, Wheat)
- response.x : air temperatures (°C)
- response.y : corresponding thermal time values (°Cd)

Usage in parent QMD:

1. Add parameters in YAML front matter:
      params:
        plant: Oats
        response.x: [0, 30, 40]
        response.y: [0, 30, 0]
        three_cardinal: false
        reference: ""

2. Include this shared documentation file using include shortcode        

-->

```{r setup, echo = FALSE}
setup_qmd()

response_x <- params$response.x
response_y <- params$response.y
stopifnot(length(response_x) == length(response_y))
is_three_cardinal <- length(response_x) == 3
reference <- if (is.null(params$reference)) {
    params$reference
} else {
    ""
}
```



Thermal time (also called growing degree days) is the primary driver of phenological development in the [`r params$plant`](/docs/Plants/`r params$plant`/index.qmd) model. It determines the rate of developmental progress through crop's phases and is used by organs to determine potential growth rates.


## Overview

* **Biological role:** Thermal time quantifies the accumulated heat exposure experienced by the crop, translating calendar time into physiological time based on temperature. It represents the effective temperature for plant development above a base temperature.

* **Placement in crop system:** Thermal time is calculated daily within the Phenology component and serves as the fundamental progression driver for all phenological phases (Germinating, Emerging, Vegetative, Reproductive, Grain Filling) and many organ growth processes.

* **Importance for agronomy or breeding:** Thermal time allows prediction of crop development stages under varying temperature regimes, enabling better crop management decisions (sowing dates, irrigation timing, harvest scheduling) and breeding selection for different thermal environments.

* **Environmental sensitivities:** 
  - **Temperature**: Primary driver - responds to air temperature with three cardinal temperatures defining the response curve
  - **Diurnal temperature variation**: Captured through [sub-daily interpolation](/docs/Models/Functions/SubDailyInterpolation.qmd) to account for temperature fluctuations throughout the day with [three-hourly interpolation method](/docs/Models/Functions/ThreeHourAirTemperature.qmd)


## Component Interaction Map

* **Inputs:** 
    - Daily maximum air temperature (from Weather)
    - Daily minimum air temperature (from Weather)

* **Outputs:**
    - Daily thermal time (°Cd) - used by all phenology phases



## Methodology

### Interpolation of sub-daily temperature


The daily minimum and maximum air temperatures are used to calculate thermal time using sub-daily interpolation with [three-hourly intervals](/docs/Models/Functions/ThreeHourAirTemperature.qmd).

```{r fig-three-hourly-temperature, fig.height = 3, fig.cap="Three-Hourly Air Temperature Interpolation with daily minimum of 10°C and maximum of 30°C"}

plot_3_hour_interpolation()

```

### Three-hourly Thermal Time 

**Key biological assumptions**

::: {.content-visible  when-meta="params.three_cardinal"}

- Plant development rate increases linearly with temperature between base (`r response_x[1]`°C) and optimum (`r response_x[2]`°C) temperatures
- Development ceases below the base temperature (`r response_x[1]`°C) and above a maximum temperature (`r response_x[3]`°C)
- Development rate declines linearly between optimum and maximum temperatures
- Diurnal temperature variation affects development - captured through [sub-daily interpolation](/docs/Models/Functions/SubDailyInterpolation.qmd) rather than simple daily mean temperature
- The same thermal time response applies across all developmental phases (no phase-specific temperature responses)

:::

::: {.content-visible  unless-meta="params.three_cardinal"}

TODO: Thermal time response must be defined by exactly three cardinal temperatures.

:::



**Mathematical representation:**

At **each** three-hour interval, the air temperature is converted to thermal time using the prescribed temperature response curve `r params$reference` through linear interpolation between points:


```{r plot-thermal-time, fig.height = 3, fig.cap="Thermal Time Function with Three Cardinal Temperatures"}

plot_cardinal_temperature(response_x, response_y)
```


::: {.content-visible  when-meta="params.three_cardinal"}

The thermal time response to air temperature ($T$) follows a three-cardinal-temperature model (`r response_x[1]`°C (base), `r response_x[2]`°C (optimum), and `r response_x[3]`°C (maximum)):

$$
TT_{i} = \begin{cases}
0 & \text{if } T \leq `r response_x[1]`°C \\
T & \text{if } `r response_x[1]`°C < T \leq `r response_x[2]`°C \\
`r response_y[2]` - \frac{`r response_y[2]`}{`r response_x[3]` - `r response_x[2]`}(T - `r response_x[2]`) & \text{if } `r response_x[2]`°C < T \leq `r response_x[3]`°C \\
0 & \text{if } T > `r response_x[3]`°C
\end{cases}
$$

Where $TT_{i}$ is the thermal time (°Cd) at temperature $T$ (°C).

:::

### Daily Thermal Time 

Daily thermal time is calculated using [sub-daily interpolation](/docs/Models/Functions/SubDailyInterpolation.qmd) with three-hourly thermal time values. Air temperature is interpolated from daily maximum and minimum using the [three-hourly air temperature interpolation](/docs/Models/Functions/ThreeHourAirTemperature.qmd) method, and the thermal time response is applied at each three-hour interval, then aggregated to give the daily total:

$$
TT_{\text{daily}} = \frac{1}{8} \sum_{i=1}^{8} TT_{t}(T_{i})
$$

where $T_i$ represents the interpolated temperature at each three-hour interval.


## Cultivar-Specific Parameters

The thermal time calculation itself has no cultivar-specific parameters - the temperature response is fixed for all `r params$plant` genotypes.

## Practical Example

For a day with:

- Maximum temperature: 35°C
- Minimum temperature: 10°C

Three hourly air temperatures are interpolated using [three-hourly interpolation](/docs/Models/Functions/ThreeHourAirTemperature.qmd). Then three hourly thermal time values are calculated using the defined temperature response curve. 

```{r thermal-time-example}
df <- three_hourly_t(10, 35) |> 
    dplyr::mutate(TT = weaana::interpolationFunction(
      response_x, response_y, values = Temperature))
df |> 
  knitr::kable(col.names = c("3-Hour Period", "Temperature (°C)", "Thermal Time (°Cd)"), digits = c(0, 1, 1))
```


Finally, the daily thermal time is the average of the eight three-hourly thermal time values (i.e. `r round(mean(df$TT), 1)` °Cd).


```{r fig-thermal-time-example, fig.height = 5, fig.cap="Three-Hourly Air Temperature and Corresponding Thermal Time Values. The black horizontal line indicates the daily thermal time."}

df |> 
    tidyr::pivot_longer(cols = c(Temperature, TT), names_to = "Type", values_to = "Value") |>
    mutate(Type = dplyr::case_when(
        Type == "Temperature" ~ "Air Temperature (°C)",
        Type == "TT" ~ "Thermal Time (°Cd)"
    )) |>
    ggplot2::ggplot(ggplot2::aes(x = Hour, y = Value, color = Type, shape = Type)) +
        ggplot2::geom_line(size = 1.2) +
        ggplot2::geom_point(size = 3) +
        ggplot2::scale_x_continuous(breaks = seq(1, 8, by = 1)) +
        ggplot2::labs(
            x = "3-Hour Period",
            y = "Value",
            color = "",
            shape = ""
        ) +
        theme_bw() +
        theme(legend.position = "bottom") +
        geom_hline(yintercept = mean(df$TT), color = "black")
```

## See Also

* [SubDailyInterpolation Function](/docs/Models/Functions/SubDailyInterpolation.qmd)
* [ThreeHourAirTemperature Function](/docs/Models/Functions/ThreeHourAirTemperature.qmd)
* [Phenology Overview](index.qmd)

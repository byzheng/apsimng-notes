---
title: "FinalLeafNumberSet"
output: html_document
---


```{r setup, echo = FALSE}
setup_qmd()
```

The `FinalLeafNumberSet` model stores final leaf number (FLN) observations or estimates for a genotype under controlled environmental conditions. These observations help quantify the effects of vernalisation and photoperiod treatments on leaf development, supporting genotype-specific modelling of phenology in APSIM NG.

## Overview

`FinalLeafNumberSet` defines the final leaf number (FLN) under four treatments in the controlled environments [@bloomfield_vernalisation_2023]:

* **LV**: fully vernalised long photoperiod
* **SV**: fully vernalised short photoperiod
* **SN**: un-vernalised short photoperiod
* **LN**: un-vernalised long photoperiod

This model is typically used within the [CAMP](CAMP.qmd)  framework to parameterise genotype responses.

## Inputs

This model does not accept dynamic inputs during simulation, but rather defines fixed parameters:

- **MinLN**: Base final leaf number under full vernalisation and long photoperiod.
- **PpLN**: Increase in FLN when grown under short photoperiod (e.g. 8h) after full vernalisation.
- **VrnLN**: Increase in FLN due to lack of vernalisation when grown under short photoperiod.
- **VxPLN**: Modification to FLN due to photoperiod interaction under unvernalised conditions.

These values are typically derived from controlled environment experiments.

## Methodology

The model exposes computed FLN values based on defined treatment combinations:

- **LV** (Long photoperiod, fully vernalised):  

$$ \text{LV} = \text{MinLN} $$

- **SV** (Short photoperiod, fully vernalised):  

$$ \text{SV} = \text{MinLN} + \text{PpLN} $$

- **SN** (Short photoperiod, un-vernalised):  

$$ \text{SN} = \text{MinLN} + \text{PpLN} + \text{VrnLN} $$

- **LN** (Long photoperiod, un-vernalised):  
$$ \text{LN} = \text{MinLN} + \text{VrnLN} + \text{VxPLN} $$

These equations represent the phenotypic plasticity of FLN in response to vernalisation and photoperiod interactions.

Reversely, the model parameters can be derived from the final leaf number (FLN) values observed in the controlled environment experiments:

- **MinLN**:  

$$ \text{MinLN} = \text{LV} $$ 

- **PpLN**:  

$$ \text{PpLN} = \text{SV} - \text{LV} $$

- **VrnLN**:  

$$ \text{VrnLN} = \text{SN} - \text{SV} $$

- **VxPLN**:

$$ \text{VxPLN} = \text{LN} - \text{LV} - \left(\text{SN} - \text{SV}\right) $$



## Events 

**Events Listened For**

> No events are listened by this function.

**Events Raised to**

> No events are raised by this function.

## Properties

**Configurable and Reportable Properties**

| Property    | Type   | Description                                                                 |
|-------------|--------|-----------------------------------------------------------------------------|
| MinLN       | double | Final Leaf Number under full vernalisation and long photoperiod (>16h)      |
| PpLN        | double | Increase in FLN under short photoperiod (<8h) following full vernalisation  |
| VrnLN       | double | Increase in FLN when un-vernalised and grown under short photoperiod        |
| VxPLN       | double | Change in FLN from photoperiod effect under un-vernalised, long-day growth  |

**Read-Only Reportable Properties**

| Property    | Type   | Description                                                                 |
|-------------|--------|-----------------------------------------------------------------------------|
| LV          | double | FLN under full vernalisation and long photoperiod (>16h)                    |
| SV          | double | FLN under full vernalisation and short photoperiod (<8h)                    |
| SN          | double | FLN when un-vernalised under short photoperiod                              |
| LN          | double | FLN when un-vernalised under long photoperiod                               |

## User Interface

`FinalLeafNumberSet` can be added as a child of a `CAMP` node in the model tree. Right-click the `CAMP` node, select "Add Model...", and search for `FinalLeafNumberSet` in the Filter Box.

## Practical Example


```{r define-parameters}
fln_data <- data.frame(
    Parameter_FLN = c("MinLN", "PpLN", "VrnLN", "VxPLN"),
    Emu_Rock = c(6, 1, 1, -1),
    Sunlamb = c(7, 5, 10, -5)
) |> 
    pivot_longer(cols = c("Emu_Rock", "Sunlamb"), names_to = "Cultivar", values_to = "FLN")

fln_long <- calculate_fln(fln_data)
```

Below is a summary table for two cultivars including very quick maturity `Emu_Rock` and very late maturity Sunlamb, showing their parameter values and calculated FLN for each treatment:

```{r tbl-cultivar-parameters, results = "asis"}
fln_long |>
    dplyr::select(Parameter = Parameter_FLN, Cultivar, FLN) |>
    pivot_wider(names_from = Cultivar, values_from = FLN) |>
    knitr::kable(digits = 2, caption = "Final Leaf Number Parameters for Emu_Rock and Sunlamb Cultivars")
```


This figure illustrates the final leaf number (FLN) for the BattenWinter and BattenSpring cultivars under different treatments, including the contributions of each parameter to the final leaf number.

```{r fig-fln, fig.height=8, fig.cap="Final Leaf Number (FLN) for BattenWinter and BattenSpring cultivars"}
library(ggplot2)
library(tidyr)
library(dplyr)        
plot_fln(fln_data)
```



## See Also

* **Source code:** [FinalLeafNumberSet.cs on GitHub](http://github.com/APSIMInitiative/ApsimX/blob/master/Models/PMF/Phenology/CAMP/FinalLeafNumberSet.cs)
